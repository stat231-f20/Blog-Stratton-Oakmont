---
title: "BlogCode"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(janitor)
library(tidyverse)
library(lubridate)
library(ical)
library(mosaic)
library(kableExtra)
library(lme4)
```



```{r}
# read in csv data
WorldData <- read_csv('worldData.csv')
esg <- read_csv('ESG_Data.csv')
esg <- clean_names(esg)

# prepare data for plots 
esg2 <- esg %>% 
  # add sector variable
  mutate(sector = case_when(industry == 'Retail' |
                              industry == 'Automotive' ~ 'Consumer Discretionary',
                            industry == 'Oil and Gas' |
                              industry == 'Oil and gas' ~ 'Energy',
                            industry == 'Electronics' |
                              industry == 'Technology' |
                              industry == 'Software' ~ 'Technology',
                            industry == 'Healthcare' |
                              industry == 'Pharmaceuticals' |
                              industry == 'Health Insurance' |
                              industry == "Pharmaceuiticals Manufacturing" |
                              industry == "Pharmaceuticals Manufacturing" ~ 'Health Care',
                            industry == 'Financials' |
                              industry == 'Financial' |
                              industry == 'Insurance' |
                              name == 'Berkshire Hathaway' ~ 'Financials',
                            industry == 'Telecommunications' |
                              industry == 'Telecom Hardware Manufacturing' ~ 'Telecommunications',
                            industry == 'Aerospace and defense' |
                              industry == 'Airspace and defense' |
                              industry == 'Aerospace and Defense' |
                              industry == 'Transportation' |
                              industry == 'Machinery' |
                              industry == 'Airlines' |
                              name == 'General Electric' |
                              name == 'United Technologies' ~ 'Industrials',
                            industry == 'Media' ~ 'Communication Services',
                            industry == 'Beverage' |
                              industry == 'Food production' |
                              industry == 'Food Service' |
                              industry == 'Food Processing' ~ 'Consumer Staples',
                            industry == 'Chemicals' ~ 'Materials')) %>%
  # change revenue growth to numeric var
  mutate(revenue_growth = parse_number(revenue_growth)) %>%
  # isolate State into its own variable
  separate(headquarters, into = c('County', 'State'), sep = ', ') %>%
  mutate(State = ifelse(State == 'Cook County','Illinois', State))

# group similar sectors together for stat analyses
esg_grouped <- esg2 %>%
  mutate(sector_group = case_when(
    sector == 'Communication Services' |
      sector == 'Telecommunications' |
      sector == 'Technology' ~ "Tech, Telecomm, and Communications",
    sector == 'Consumer Discretionary' |
      sector == 'Consumer Staples' ~ 'Consumer Disc. and Staples',
    sector == 'Financials' ~ 'Financials',
    sector == 'Energy' |
      sector == 'Materials' |
      sector == 'Industrials' ~ 'Energy, Materials, and Industrials',
    sector == 'Health Care' ~ 'Health Care')) %>%
  filter(name != 'Dow, Inc' & name != 'Cigna')

# esg by Sector Group; Boxplot 
box <- ggplot(data = esg_grouped, aes(y = sector_group, x = esg)) +
  geom_boxplot(aes(color = sector_group)) +
  ggtitle('ESG Score by Sector Group') +
  labs(x = 'ESG Score', y = 'Sector Group') +
  theme_light()

box + theme(legend.position = "none")

# modify data for table
esg_table <- esg_grouped %>%
  group_by(sector_group) %>%
  summarize('Mean Score' = mean(esg), 'median_score' = median(esg), 
            'Std. Deviation' = sd(esg)) %>%
  arrange(desc(median_score))


kable(esg_table, digits = 4, format = "html", row.names = FALSE,
      col.names = c('Sector Group', 'Mean Score', 'Median Score',
                               'Std. Deviation'), 
      caption = 'ESG Score by Sector Group') %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = F,
                font_size = 14,
                position = "left")



# esg and revenue growth, point 
gpoint <- ggplot(data = esg_grouped, aes(x = esg, y = revenue_growth)) +
  geom_point(aes(color = sector_group)) +
  stat_smooth(aes(group = sector_group, color = sector_group), method = "lm", se = FALSE) +
  ggtitle('ESG Score and Revenue Growth') +
  labs(x = 'ESG Score', y = 'Revenue Growth (%)', color = 'Sector Group') +
  theme_light()
gpoint
gpoint + facet_wrap(~sector_group) + geom_smooth(method = 'lm')
# geom_smooth(method='lm') 

# overall regression
mod <- lm(revenue_growth ~ esg, data = esg_grouped)
summary(mod)

# regression by sector group
mm <- lmList(revenue_growth~esg|sector_group, esg_grouped)
summary(mm)
# geom_smooth(method='lm', formula= revenue_growth~esg)
groups <- unique(esg_grouped$sector_group)
coefs <- coef(mm)
coefs

# coeffs <- coefficients(revenue_growth~esg|sector_group, data = esg_grouped)
# coeffs
mm <- lmList(revenue_growth~esg|sector_group, esg_grouped)
reg_stats <- array(NA, dim=c(5,4))

for (k in 1:length(groups)) {
  reg_stats[k, 1] <- groups[k]
  reg_stats[k, 2] <-  (summary(mm)$coeff)[groups[k], 'Estimate', 'esg']
  reg_stats[k, 3] <- (summary(mm)$coeff)[groups[k], 'Pr(>|t|)', 'esg']
}
regression <- as.data.frame(reg_stats) %>%
  mutate('p-value' = as.numeric(V3), 'Coeff. Estimate' = as.numeric(V2)) %>%
  select('Sector Group' = V1, 'Coeff. Estimate', 'p-value')
regression

kable(regression, digits = 4, row.names = FALSE,
      caption = 'Linear Regression: ESG Score Predicting Revenue Growth') %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = F,
                font_size = 14,
                position = "left")

# remove emojis from World dataset
WorldData2 <- WorldData %>%
  separate(Country, into = c('extra', 'Country1', 'Country2'), sep = " ") %>%
  mutate(Country = str_replace(paste(Country1, Country2), 'NA', ""))
```

```{r}
#Loading Datasets
library(maps)
data(state)
library(viridis)
#Wrangling Datasets
USData <- esg3 %>%
  select(esg, State) %>%
  group_by(State) %>%
  summarize(ESG = mean(esg)) %>%
  mutate(State = tolower(State))
States <- map_data(map = "state"
                       , region = ".") 
#Merging with Map Dataset
USMap <- USData %>%
  right_join(States, by = c("State" = "region")) 

#Creating Map
ggplot(USMap, aes(x = long, y = lat, group = group
                      , fill = ESG)) +
  geom_polygon(color = "white") +
  theme_void() +
  coord_fixed(ratio = 1.3) +
  labs(title = "Which States House Sustainable Companies?"
       , subtitle = "The average ESG of companies headquartered in each state."
       , caption = "*Grey states do not contain a Fortune 100 Company"
       , fill = "Average ESG Score") +
  scale_fill_viridis(option = "brewer blues", direction = -1)

```

```{r}
#Global Sustainability Leaflet
library(maps)
library(leaflet)
#Data Wrangling
GlobalData <- WorldData2 %>%
  select(Company, Country) %>%
  mutate(`Country` = ifelse(`Country` == 'CA ','Canada',`Country`)) %>%
  mutate(`Country` = ifelse(`Country` == 'U.S. ','USA',`Country`)) %>%
  mutate(`Country` = as.character(`Country`)) %>%
  mutate(`Country` = gsub(" ","",`Country`))

#Adding Map Data
WorldMap <- map_data(map = "world", region = ".") %>%
  select(region, lat, long, group) %>%
  group_by(region) %>%
  summarize(long = mean(long),lat = mean(lat)) %>%
  rename(`Country` = region) %>%
  mutate(`Country` = gsub(" ","",`Country`))

#Merging Datasets
GlobalMap <- GlobalData %>%
  inner_join(WorldMap) %>%
  group_by(Country, long, lat) %>%
  summarize(Companies = paste(Company, collapse = "<br>"), count = n())

#Creating Global Sustainability Leaflet
GlobalLeaflet <- leaflet(GlobalMap) %>%
  addTiles() %>%
  addCircleMarkers(lat = ~lat
                   , lng = ~long
                   , popup = GlobalMap$Companies
                   , stroke = FALSE 
                   , radius = ~count
                   , fillOpacity = 0.9) 
GlobalLeaflet




  
```

