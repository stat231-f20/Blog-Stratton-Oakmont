---
title: "BlogCode"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(janitor)
library(tidyverse)
library(lubridate)
library(ical)
```



```{r}
WorldData <- read_csv('worldData.csv')
esg <- read_csv('ESG_Data.csv')
esg <- clean_names(esg)
esgtest <- esg %>% mutate(test = case_when(industry == 'Retail' | industry == 'Automotive' ~ 'Consumer Discretionary'))
# add sector variable 
esg2 <- esg %>% 
  mutate(sector = case_when(industry == 'Retail' |
                              industry == 'Automotive' ~ 'Consumer Discretionary',
                            industry == 'Oil and Gas' |
                              industry == 'Oil and gas' ~ 'Energy',
                            industry == 'Electronics' |
                              industry == 'Technology' |
                              industry == 'Software' ~ 'Technology',
                            industry == 'Healthcare' |
                              industry == 'Pharmaceuticals' |
                              industry == 'Health Insurance' |
                              industry == "Pharmaceuiticals Manufacturing" |
                              industry == "Pharmaceuticals Manufacturing" ~ 'Health Care',
                            industry == 'Financials' |
                              industry == 'Financial' |
                              industry == 'Insurance' |
                              name == 'Berkshire Hathaway' ~ 'Financials',
                            industry == 'Telecommunications' |
                              industry == 'Telecom Hardware Manufacturing' ~ 'Telecommunications',
                            industry == 'Aerospace and defense' |
                              industry == 'Airspace and defense' |
                              industry == 'Aerospace and Defense' |
                              industry == 'Transportation' |
                              industry == 'Machinery' |
                              industry == 'Airlines' |
                              name == 'General Electric' |
                              name == 'United Technologies' ~ 'Industrials',
                            industry == 'Media' ~ 'Communication Services',
                            industry == 'Beverage' |
                              industry == 'Food production' |
                              industry == 'Food Service' |
                              industry == 'Food Processing' ~ 'Consumer Staples',
                            industry == 'Chemicals' ~ 'Materials'))
esg3 <- esg2 %>% 
  mutate(revenue_growth = parse_number(revenue_growth)) %>%
  separate(headquarters, into = c('County', 'State'), sep = ', ') %>%
  mutate(State = ifelse(State == 'Cook County','Illinois', State))
  
# esg by sector boxplot 
box <- ggplot(data = esg2, aes(x = sector, y = esg)) +
  geom_boxplot()
box
# esg and revenue growth, point 
gpoint <- ggplot(data = esg3, aes(x = esg, y = revenue_growth)) +
  geom_point(aes(color = sector))
gpoint
gpoint + facet_wrap(~sector)
# geom_smooth(method='lm') 
# geom_smooth(method='lm', formula= revenue_growth~esg)

WorldData2 <- WorldData %>%
  separate(Country, into = c('extra', 'Country1', 'Country2'), sep = " ") %>%
  mutate(Country = str_replace(paste(Country1, Country2), 'NA', ""))
```

```{r}
#Loading Datasets
library(maps)
data(state)
library(viridis)
#Wrangling Datasets
USData <- esg3 %>%
  select(esg, State) %>%
  group_by(State) %>%
  summarize(ESG = mean(esg)) %>%
  mutate(State = tolower(State))
States <- map_data(map = "state"
                       , region = ".") 
#Merging with Map Dataset
USMap <- USData %>%
  right_join(States, by = c("State" = "region")) 

#Creating Map
ggplot(USMap, aes(x = long, y = lat, group = group
                      , fill = ESG)) +
  geom_polygon(color = "white") +
  theme_void() +
  coord_fixed(ratio = 1.3) +
  labs(title = "Which States House Sustainable Companies?"
       , subtitle = "The average ESG of companies headquartered in each state."
       , caption = "*Grey states do not contain a Fortune 100 Company"
       , fill = "Average ESG Score") +
  scale_fill_viridis(option = "brewer blues", direction = -1)

```

```{r}
#Global Sustainability Leaflet
library(maps)
library(leaflet)
#Data Wrangling
GlobalData <- WorldData2 %>%
  select(Company, Country) %>%
  mutate(`Country` = ifelse(`Country` == 'CA ','Canada',`Country`)) %>%
  mutate(`Country` = ifelse(`Country` == 'U.S. ','USA',`Country`)) %>%
  mutate(`Country` = as.character(`Country`)) %>%
  mutate(`Country` = gsub(" ","",`Country`))

#Adding Map Data
WorldMap <- map_data(map = "world", region = ".") %>%
  select(region, lat, long, group) %>%
  group_by(region) %>%
  summarize(long = mean(long),lat = mean(lat)) %>%
  rename(`Country` = region) %>%
  mutate(`Country` = gsub(" ","",`Country`))

#Merging Datasets
GlobalMap <- GlobalData %>%
  inner_join(WorldMap) %>%
  group_by(Country, long, lat) %>%
  summarize(Companies = paste(Company, collapse = ", "), count = n())

#Creating Global Sustainability Leaflet
GlobalLeaflet <- leaflet(GlobalMap) %>%
  addTiles() %>%
  addCircleMarkers(lat = ~lat
                   , lng = ~long
                   , popup = GlobalMap$Companies
                   , stroke = FALSE 
                   , radius = ~count
                   , fillOpacity = 0.9) 
GlobalLeaflet

# create dataset (companies that have the same lat  and long)
# dataset with 1 row per country -- have variable that represents number of companies
# in each country 
# <br>

  
```

